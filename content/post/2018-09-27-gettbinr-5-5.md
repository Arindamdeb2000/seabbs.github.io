---
title: getTBinR 0.5.5 now on CRAN - 2017 data.
author: ~
date: '2018-09-27'
slug: gettbinr-5-5
twitterImg: img/getTBinR/storyboard-5-5.png
description: "getTBinR version 0.5.5 now with 2017 data, smarter defaults and better docs. What has changed in 2017?"
categories: ["R"]
tags: ["data analysis", "data visualisation", "rstats", "TB", "WHO", "getTBinR", "infectious disease"]
---

[`getTBinR 0.5.5`](https://www.samabbott.co.uk/getTBinR/) is now on CRAN and should be available on a mirror near you shortly! This update is mainly about highlighting the availability of TB data for 2017, although some small behind the scenes changes were required to get the code set up going forward for yearly updates. A few more plotting options have been added, along with the corresponding tests (definitely the most exciting news). The full changelog is below along with a short example highlighting some of the changes in the 2017 data.

## Feature updates

* Added a years filter to `plot_tb_burden` and `plot_tb_burden_overview`. This allows a range of years to be plotted. The default is all years which was the previous de facto default.  

## Package updates

* Updated docs to reflect new year of data.
* Updated examples to use the new year of data as standard.
* Updated README to always use the current year of data.
* Updated all vignettes to reflect new data or be fixed to historic data as appropriate.
* Update site with links out to blog posts using the newest version of [`pkgdown`](http://pkgdown.r-lib.org).

## Example: Changes in TB incidence rates in 2017

The code below quickly explores the updated data by first plotting the annual change in TB incidence rates over time both overall and by region. The trend in incidence rates is then explored using country and regional level TB incidence rates. See [here](https://www.samabbott.co.uk/img/getTBinR/storyboard-5-5.png) for a full size version of the storyboard.

```r
## Get required packages - managed using pacman
if (!require(pacman)) install.packages("pacman"); library(pacman)
p_load("getTBinR")
p_load("ggplot2")
p_load("ggrepel")
p_load("scales")
p_load("viridis")
p_load("dplyr")
p_load("forcats")
p_load("ggridges")
p_load_gh("thomasp85/patchwork")

##Pull TB data and remove countries with fewer than 10 cases per 100,000 or 1000 cases overall (to reduce noise)
tb_burden <- get_tb_burden() 

countries_with_tb_burden <- tb_burden %>% 
  filter(year == 2017,
         e_inc_100k > 10,
         e_inc_num > 1000)

tb_annual_change <- tb_burden %>% 
  semi_join(countries_with_tb_burden, by = "country") %>% 
  group_by(country) %>% 
  arrange(year) %>% 
  select(year, g_whoregion, country, e_inc_100k, e_inc_num, e_pop_num) %>% 
  mutate(annual_change = (e_inc_100k - lag(e_inc_100k)) / lag(e_inc_100k)) %>% 
  ungroup

## Function to plot annual change
plot_annual_change <- function(df, strat = NULL, subtitle = NULL, years = 2000:2017) {
  dist <- df %>% 
    filter(year %in% years) %>% 
    rename(Region = g_whoregion) %>% 
    mutate(year = year %>% 
             factor(ordered = TRUE) %>% 
             fct_rev) %>% 
    ggplot(aes_string(x = "annual_change", y = "year", col = strat, fill = strat)) +
    geom_density_ridges(quantile_lines = TRUE, quantiles = 2, alpha = 0.6) +
    scale_color_viridis(discrete = TRUE, end = 0.9) +
    scale_fill_viridis(discrete = TRUE, end = 0.9) +
    geom_vline(xintercept = 0, linetype = 2, alpha = 0.6) +
    scale_x_continuous(labels = scales::percent, breaks = seq(-0.4, 0.4, 0.1),
                       limits = c(-0.4, 0.4), minor_breaks = NULL) +
    theme_minimal() +
    theme(legend.position = "none") +
    labs(x = paste0("Annual Change in ", search_data_dict("e_inc_100k")$definition),
         y = "Year",
         title = "Annual Percentage Change in Tuberculosis Incidence Rates (per 100,000)",
         subtitle = subtitle,
         caption = "For the annual percentage change countries with incidence above 1000 and an incidence rate above 10 per 100,000 are shown. \n By @seabbs | Made with getTBinR | Source: World Health Organisation")
  
  return(dist)
}

## Overall annual change
overall <- plot_annual_change(tb_annual_change, "year",
                              years = 2001:2017) 
## Regional annual change
region <-  plot_annual_change(tb_annual_change, "Region",
                              subtitle = "By Region", 
                              years = seq(2001, 2017, 2)) + 
  facet_wrap(~Region) +
  labs(caption = "")

## Regional TB incidence rates over time
regional_incidence <- tb_burden %>% 
  group_by(g_whoregion, year) %>% 
  summarise(inc = sum(e_inc_num, na.rm = TRUE), pop = sum(e_pop_num, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(inc_rate = inc / pop * 1e5) %>% 
  mutate(label = ifelse(year == max(year), g_whoregion, "")) %>% 
  ggplot(aes(year, inc_rate, col = g_whoregion)) +
  geom_line(alpha = 0.8, size = 1.2) +
  scale_color_viridis(discrete = TRUE, end = 0.9) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_y_continuous(breaks = seq(0, 400, 25), minor_breaks = NULL, limits = c(0, NA)) +
  scale_x_continuous(breaks = seq(2000, 2017, 1), minor_breaks = NULL) +
  geom_text_repel(aes(label = label),
                  nudge_x = 4,
                  force = 10,
                  na.rm = TRUE,
                  min.segment.length = 10) +
  labs(x = search_data_dict("e_inc_100k")$definition,
       y = "Year",
       title = "Tuberculosis Incidence Rates (per 100,000)",
       subtitle = "By Region")

## Map global TB incidence rates for 2017 using getTBinR
map <- map_tb_burden(year = c(2005, 2009, 2013, 2017), facet = "year") +
  theme(strip.background = element_blank()) +
  labs(caption = "",
       title = "Tuberculosis Incidence Rates (per 100,000)",
       subtitle = "By Country")

## Compose storyboard
storyboard <- (map + regional_incidence + plot_layout(widths = c(2, 1))) /
  (region + overall+ plot_layout(widths = c(2, 1))) +
  plot_layout(widths = c(1, 1))

## Save storyboard
ggsave("storyboard.png",
       storyboard, width = 20, height = 15, dpi = 330)
```

![getTBinR 0.5.4 storyboard](/img/getTBinR/storyboard-5-5.png)

For other examples of using `getTBinR` to visualise the WHO TB data see [my](https://gist.github.com/seabbs) gists, previous blog [posts](https://www.samabbott.co.uk/tags/who/), and the [`getTBinR` website](https://www.samabbott.co.uk/getTBinR/).
